{"version":3,"sources":["webpack:///webpack/bootstrap 1c01bfd96108b5a19c80","webpack:///external \"lodash\"","webpack:///external \"moment\"","webpack:///external \"bluebird\"","webpack:///./src/db.js","webpack:///./src/util.js","webpack:///./src/index.js","webpack:///external \"botpress-version-manager\"","webpack:///external \"botpress\"","webpack:///external \"later\"","webpack:///external \"cronstrue\"","webpack:///external \"validate-arguments\"","webpack:///./src/daemon.js"],"names":["Validate","require","module","exports","bootstrap","bp","db","get","then","initialize","create","id","options","knex","update","updateTask","taskId","status","logs","returned","delete","remove","deleteDone","listUpcoming","listPrevious","listExpired","scheduleNext","time","reviveAllExecuting","createTableIfNotExists","table","string","primary","boolean","timestamp","increments","references","onDelete","unique","String","Math","random","validateCreateOptions","schedule_human","getHumanExpression","schedule_type","schedule","firstOccurence","getNextOccurence","toDate","insert","created_on","date","now","enabled","Promise","resolve","where","includes","finishedOn","del","deleteScheduled","join","dt","whereRaw","isBefore","andWhere","select","scheduleId","coeff","rounded","Date","round","getTime","ts","format","scheduledOn","whereNotNull","args","named","action","isValid","errorString","validateExpression","pick","validateModifyOptions","cronstrue","type","exp","toLowerCase","toString","localTime","sched1","parse","cron","next1","next","add","sched2","text","next2","Error","fromNow","config","init","botpressPath","d","revive","start","ready","router","getRouter","catchError","message","err","res","send","req","sortBy","schedules","map","s","scheduleOn","catch","put","body","events","emit","post","sendStatus","query","scheduler","scheduleType","timerInterval","lock","daemon","createDaemon","reschedule","task","nextOccurence","runSingleTask","expired","result","logger","debug","AsyncFunction","eval","fn","fromDate","untilDate","logsQuery","from","until","limit","order","fields","fromCallback","callback","flattenLogs","file","x","_run","rescheduled","list","mapSeries","error","stack","notifications","level","finally","run","clearInterval","setInterval","stop"],"mappings":"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","file":"node.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"C:\\\\Users\\\\AranM\\\\Projects\\\\botpress-10\\\\packages\\\\functionals\\\\botpress-scheduler\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 1c01bfd96108b5a19c80","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"moment\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"moment\"\n// module id = 1\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 2\n// module chunks = 0","import _ from 'lodash'\r\nimport { DatabaseHelpers as helpers } from 'botpress'\r\n\r\nconst Validate = require('validate-arguments')\r\n\r\nimport util from './util.js'\r\n\r\nmodule.exports = bp => {\r\n  return {\r\n    bootstrap: () => {\r\n      return bp.db.get().then(initialize)\r\n    },\r\n    create: (id, options) => {\r\n      return bp.db.get().then(knex => create(knex, id, options))\r\n    },\r\n    update: (id, options) => {\r\n      return bp.db.get().then(knex => update(knex, id, options))\r\n    },\r\n    updateTask: (taskId, status, logs, returned) => {\r\n      return bp.db.get().then(knex => updateTask(knex, taskId, status, logs, returned))\r\n    },\r\n    delete: id => {\r\n      return bp.db.get().then(knex => remove(knex, id))\r\n    },\r\n    deleteDone: () => {\r\n      return bp.db.get().then(knex => deleteDone(knex))\r\n    },\r\n    listUpcoming: () => {\r\n      return bp.db.get().then(knex => listUpcoming(knex))\r\n    },\r\n    listPrevious: () => {\r\n      return bp.db.get().then(knex => listPrevious(knex))\r\n    },\r\n    listExpired: () => {\r\n      return bp.db.get().then(knex => listExpired(knex))\r\n    },\r\n    scheduleNext: (id, time) => {\r\n      return bp.db.get().then(knex => scheduleNext(knex, id, time))\r\n    },\r\n    reviveAllExecuting: () => {\r\n      return bp.db.get().then(knex => reviveAllExecuting(knex))\r\n    }\r\n  }\r\n}\r\n\r\nfunction initialize(knex) {\r\n  return helpers(knex)\r\n    .createTableIfNotExists('scheduler_schedules', function(table) {\r\n      table.string('id').primary()\r\n      table.boolean('enabled')\r\n      table.string('schedule_type')\r\n      table.string('schedule')\r\n      table.string('schedule_human')\r\n      table.timestamp('created_on')\r\n      table.string('action')\r\n    })\r\n    .then(function() {\r\n      return helpers(knex).createTableIfNotExists('scheduler_tasks', function(table) {\r\n        table.increments('id')\r\n        table\r\n          .string('scheduleId')\r\n          .references('scheduler_schedules.id')\r\n          .onDelete('CASCADE')\r\n        table.timestamp('scheduledOn')\r\n        table.string('status')\r\n        table.string('logs')\r\n        table.timestamp('finishedOn')\r\n        table.string('returned')\r\n        table.unique(['scheduleId', 'scheduledOn'])\r\n      })\r\n    })\r\n}\r\n\r\nfunction create(knex, id, options) {\r\n  id = id || String(Math.random() * 100000000000000000000) // TODO: avoid possible duplicates\r\n  options = validateCreateOptions(options)\r\n\r\n  options.schedule_human = util.getHumanExpression(options.schedule_type, options.schedule)\r\n\r\n  const firstOccurence = util.getNextOccurence(options.schedule_type, options.schedule).toDate()\r\n\r\n  return knex('scheduler_schedules')\r\n    .insert({\r\n      id,\r\n      created_on: helpers(knex).date.now(),\r\n      ...options\r\n    })\r\n    .then(() => {\r\n      if (options.enabled) {\r\n        return scheduleNext(knex, id, firstOccurence)\r\n      }\r\n    })\r\n    .then(() => Promise.resolve(id))\r\n}\r\n\r\nfunction update(knex, id, options) {\r\n  options = validateCreateOptions(options)\r\n\r\n  return knex('scheduler_schedules')\r\n    .where({ id })\r\n    .update({ ...options })\r\n    .then()\r\n}\r\n\r\nfunction updateTask(knex, taskId, status, logs, returned) {\r\n  const options = { status, logs, returned }\r\n\r\n  if (_.includes(['done', 'error', 'skipped'], status)) {\r\n    options.finishedOn = helpers(knex).date.now()\r\n  }\r\n\r\n  return knex('scheduler_tasks')\r\n    .where({ id: taskId })\r\n    .update(options)\r\n    .then()\r\n}\r\n\r\nfunction reviveAllExecuting(knex) {\r\n  return knex('scheduler_tasks')\r\n    .where({ status: 'executing' })\r\n    .update({ status: 'pending' })\r\n    .then()\r\n}\r\n\r\nfunction remove(knex, id) {\r\n  return knex('scheduler_schedules')\r\n    .where({ id })\r\n    .del()\r\n    .then(() => deleteScheduled(knex, id))\r\n}\r\n\r\nfunction listUpcoming(knex) {\r\n  return knex('scheduler_tasks')\r\n    .where({ status: 'pending' })\r\n    .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\r\n    .then()\r\n}\r\n\r\nfunction listPrevious(knex) {\r\n  const dt = helpers(knex).date\r\n\r\n  return knex('scheduler_tasks')\r\n    .whereRaw(dt.isBefore('scheduledOn', dt.now()))\r\n    .andWhere('status', '!=', 'pending')\r\n    .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\r\n    .then()\r\n}\r\n\r\nfunction listExpired(knex) {\r\n  const dt = helpers(knex).date\r\n\r\n  return knex('scheduler_tasks')\r\n    .whereRaw(dt.isBefore('scheduledOn', dt.now()))\r\n    .andWhere('status', '=', 'pending')\r\n    .join('scheduler_schedules', 'scheduler_tasks.scheduleId', 'scheduler_schedules.id')\r\n    .select(['scheduler_tasks.id as taskId', '*'])\r\n    .then()\r\n}\r\n\r\nfunction deleteScheduled(knex, id) {\r\n  return knex('scheduler_tasks')\r\n    .where({ scheduleId: id })\r\n    .del()\r\n    .then()\r\n}\r\n\r\nfunction scheduleNext(knex, id, time) {\r\n  // Round the time to the nearest 2 seconds\r\n  const coeff = 1000 * 2\r\n  const rounded = new Date(Math.round(time.getTime() / coeff) * coeff)\r\n\r\n  const ts = helpers(knex).date.format(rounded)\r\n\r\n  return knex('scheduler_tasks')\r\n    .insert({\r\n      scheduleId: id,\r\n      scheduledOn: ts,\r\n      status: 'pending'\r\n    })\r\n    .then()\r\n}\r\n\r\nfunction deleteDone(knex) {\r\n  return knex('scheduler_tasks')\r\n    .whereNotNull('finishedOn')\r\n    .del()\r\n    .then()\r\n}\r\n\r\nfunction validateCreateOptions(options) {\r\n  const args = Validate.named(options, {\r\n    enabled: 'boolean',\r\n    schedule_type: 'string',\r\n    schedule: 'string',\r\n    action: 'string'\r\n  })\r\n\r\n  if (!args.isValid()) {\r\n    throw args.errorString()\r\n  }\r\n\r\n  util.validateExpression(options.schedule_type, options.schedule)\r\n\r\n  return _.pick(options, ['enabled', 'schedule_type', 'schedule', 'action'])\r\n}\r\n\r\nfunction validateModifyOptions(options) {\r\n  const args = Validate.named(options, {\r\n    enabled: 'boolean',\r\n    action: 'string'\r\n  })\r\n\r\n  if (!args.isValid()) {\r\n    throw args.errorString()\r\n  }\r\n\r\n  return _.pick(options, ['enabled', 'action'])\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/db.js","import moment from 'moment'\r\nimport later from 'later'\r\nimport _ from 'lodash'\r\n\r\nconst cronstrue = require('cronstrue')\r\n\r\nconst getNextOccurence = (type, exp) => {\r\n  switch (type.toLowerCase()) {\r\n    case 'cron':\r\n      cronstrue.toString(exp) // Validation\r\n      later.date.localTime()\r\n      const sched1 = later.parse.cron(exp)\r\n      const next1 = later.schedule(sched1).next(\r\n        2,\r\n        moment()\r\n          .add(5, 'seconds')\r\n          .toDate()\r\n      )[0]\r\n      return moment(new Date(next1))\r\n    case 'natural':\r\n      later.date.localTime()\r\n      const sched2 = later.parse.text(exp)\r\n      const next2 = later.schedule(sched2).next(\r\n        2,\r\n        moment()\r\n          .add(5, 'seconds')\r\n          .toDate()\r\n      )[1]\r\n      return moment(new Date(next2))\r\n    case 'once':\r\n      return moment(new Date(exp))\r\n  }\r\n}\r\n\r\nconst validateExpression = (type, exp) => {\r\n  if (!_.includes(['cron', 'natural', 'once'], type.toLowerCase())) {\r\n    throw new Error('Invalid expression type: ' + type)\r\n  }\r\n\r\n  getNextOccurence(type, exp)\r\n}\r\n\r\nconst getHumanExpression = (type, exp) => {\r\n  switch (type.toLowerCase()) {\r\n    case 'cron':\r\n      return cronstrue.toString(exp)\r\n    case 'once':\r\n      return 'Once, ' + moment(new Date(exp)).fromNow()\r\n    case 'natural':\r\n      return exp\r\n    default:\r\n      throw new Error('Unknown type: ' + type)\r\n  }\r\n}\r\n\r\nmodule.exports = { getNextOccurence, validateExpression, getHumanExpression }\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/util.js","import checkVersion from 'botpress-version-manager'\r\n\r\nimport moment from 'moment'\r\nimport _ from 'lodash'\r\nimport Promise from 'bluebird'\r\n\r\nimport db from './db'\r\nimport daemon from './daemon'\r\n\r\nmodule.exports = {\r\n  config: {},\r\n\r\n  init: async function(bp) {\r\n    checkVersion(bp, bp.botpressPath)\r\n\r\n    await db(bp).bootstrap()\r\n    const d = daemon(bp)\r\n    await d.revive()\r\n    d.start()\r\n  },\r\n\r\n  ready: function(bp) {\r\n    const router = bp.getRouter('botpress-scheduler')\r\n\r\n    const catchError = res => err => {\r\n      const message = typeof err === 'string' ? err : err.message\r\n      res.status(500).send({ message })\r\n    }\r\n\r\n    router.get('/schedules/upcoming', (req, res) => {\r\n      db(bp)\r\n        .listUpcoming()\r\n        .then(schedules => {\r\n          res.send(\r\n            _.sortBy(schedules, 'scheduledOn').map(s => {\r\n              s.scheduleOn = moment(s.scheduledOn).format()\r\n              s.enabled = !!s.enabled\r\n              return s\r\n            })\r\n          )\r\n        })\r\n        .catch(catchError(res))\r\n    })\r\n\r\n    router.get('/schedules/past', (req, res) => {\r\n      db(bp)\r\n        .listPrevious()\r\n        .then(schedules => {\r\n          res.send(\r\n            _.sortBy(schedules, s => -s.scheduledOn).map(s => {\r\n              s.scheduleOn = moment(s.scheduledOn).format()\r\n              s.enabled = !!s.enabled\r\n              return s\r\n            })\r\n          )\r\n        })\r\n        .catch(catchError(res))\r\n    })\r\n\r\n    router.put('/schedules', (req, res) => {\r\n      db(bp)\r\n        .create(req.body.id, req.body)\r\n        .then(schedules => {\r\n          res.send(schedules)\r\n          bp.events.emit('scheduler.update')\r\n        })\r\n        .catch(catchError(res))\r\n    })\r\n\r\n    router.post('/schedules', (req, res) => {\r\n      db(bp)\r\n        .update(req.body.id, req.body)\r\n        .then(() => {\r\n          res.sendStatus(200)\r\n          bp.events.emit('scheduler.update')\r\n        })\r\n        .catch(catchError(res))\r\n    })\r\n\r\n    router.delete('/schedules', (req, res) => {\r\n      db(bp)\r\n        .delete(req.query.id)\r\n        .then(() => {\r\n          res.sendStatus(200)\r\n          bp.events.emit('scheduler.update')\r\n        })\r\n        .catch(catchError(res))\r\n    })\r\n\r\n    router.delete('/done', (req, res) => {\r\n      db(bp)\r\n        .deleteDone()\r\n        .then(() => {\r\n          res.sendStatus(200)\r\n          bp.events.emit('scheduler.update')\r\n        })\r\n        .catch(catchError(res))\r\n    })\r\n\r\n    bp.scheduler = {\r\n      /**\r\n       * Adds schedule record and returns promise with id of the record inserted\r\n       * @param  {string} params.schedule dateTime action will be executed\r\n       * @param  {string} params.action string that will be executed\r\n       * @param  {string} [params.id] the unique id of the schedule (if not provided will be generated automatically)\r\n       * @param  {boolean} [params.enabled=true] optional flag specifying whether this task is enabled\r\n       * @param  {string} [scheduleType='once'] type of the scheduler: 'once', 'cron' or 'natural'\r\n       */\r\n      add: ({ id, schedule, action, enabled = true, scheduleType = 'once' }) =>\r\n        db(bp)\r\n          .create(id, { schedule, action, enabled, schedule_type: scheduleType })\r\n          .then(() => bp.events.emit('scheduler.update')),\r\n      /**\r\n       * Removes schedule record and returns promise with boolean showing whether delete was successful\r\n       * @param  {string} id the id of the schedule to remove\r\n       */\r\n      remove: id =>\r\n        db(bp)\r\n          .delete(id)\r\n          .then(() => bp.events.emit('scheduler.update'))\r\n    }\r\n  }\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"botpress-version-manager\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress-version-manager\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"botpress\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"botpress\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"later\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"later\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"cronstrue\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"cronstrue\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"validate-arguments\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"validate-arguments\"\n// module id = 11\n// module chunks = 0","import Promise from 'bluebird'\r\n\r\nimport db from './db'\r\nimport util from './util'\r\nlet timerInterval = null\r\nlet lock = false\r\nlet daemon = null\r\n\r\nconst createDaemon = bp => {\r\n  const reschedule = task => {\r\n    if (task.schedule_type.toLowerCase() === 'once') {\r\n      return Promise.resolve(null)\r\n    }\r\n\r\n    const nextOccurence = util.getNextOccurence(task.schedule_type, task.schedule).toDate()\r\n\r\n    return db(bp).scheduleNext(task.id, nextOccurence)\r\n  }\r\n\r\n  const runSingleTask = async expired => {\r\n    await db(bp).updateTask(expired.taskId, 'executing', null, null)\r\n\r\n    let result = null\r\n\r\n    if (!expired.enabled) {\r\n      bp.logger.debug('[scheduler] Skipped task ' + expired.taskId + '. Reason=disabled')\r\n      await db(bp).updateTask(expired.taskId, 'skipped', null, null)\r\n      return\r\n    }\r\n\r\n    const AsyncFunction = eval('Object.getPrototypeOf(async function() {}).constructor') // eslint-disable-line no-eval\r\n    const fn = new AsyncFunction('bp', 'task', expired.action)\r\n\r\n    bp.events.emit('scheduler.update')\r\n    bp.events.emit('scheduler.started', expired)\r\n\r\n    const fromDate = new Date()\r\n    result = await fn(bp, expired)\r\n    const untilDate = new Date()\r\n\r\n    const returned = (result && result.toString && result.toString()) || result\r\n\r\n    const logsQuery = {\r\n      from: fromDate,\r\n      until: untilDate,\r\n      limit: 1000,\r\n      start: 0,\r\n      order: 'desc',\r\n      fields: ['message']\r\n    }\r\n\r\n    const logs = await Promise.fromCallback(callback => bp.logger.query(logsQuery, callback))\r\n\r\n    const flattenLogs = ((logs && logs.file && logs.file.map(x => x.message)) || []).join('\\n')\r\n\r\n    await db(bp).updateTask(expired.taskId, 'done', flattenLogs, returned)\r\n\r\n    bp.events.emit('scheduler.update')\r\n    bp.events.emit('scheduler.finished', expired)\r\n  }\r\n\r\n  const _run = async () => {\r\n    const rescheduled = {}\r\n    const list = await db(bp).listExpired()\r\n\r\n    return Promise.mapSeries(list, expired => {\r\n      return runSingleTask(expired)\r\n        .catch(err => {\r\n          bp.logger.error('[scheduler]', err.message, err.stack)\r\n          bp.notifications.send({\r\n            message:\r\n              'An error occured while running task: ' + expired.taskId + '. Please check the logs for more info.',\r\n            level: 'error'\r\n          })\r\n          return db(bp).updateTask(expired.taskId, 'error', null, null)\r\n        })\r\n        .finally(async () => {\r\n          if (!rescheduled[expired.taskId]) {\r\n            await reschedule(expired)\r\n            rescheduled[expired.taskId] = true\r\n          }\r\n        })\r\n    })\r\n  }\r\n\r\n  const run = () => {\r\n    if (lock === true) {\r\n      return\r\n    }\r\n\r\n    lock = true\r\n    return _run().finally(() => {\r\n      lock = false\r\n    })\r\n  }\r\n\r\n  const revive = () => db(bp).reviveAllExecuting()\r\n\r\n  const start = () => {\r\n    clearInterval(timerInterval)\r\n    timerInterval = setInterval(run, 5000)\r\n  }\r\n\r\n  const stop = () => clearInterval(timerInterval)\r\n\r\n  return { start, stop, revive }\r\n}\r\n\r\nmodule.exports = bp => {\r\n  if (!daemon) {\r\n    daemon = createDaemon(bp)\r\n  }\r\n\r\n  return daemon\r\n}\r\n\n\n\n// WEBPACK FOOTER //\n// ./src/daemon.js"],"sourceRoot":""}